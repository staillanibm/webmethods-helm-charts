replicaCount: 1

image:
  repository: ibmwebmethods.azurecr.io/apigateway-minimal
  pullPolicy: IfNotPresent
  tag: "11.1.0.7"

imagePullSecrets:
  - name: regcred

skipLicenseKey: true
skipKibanaAutostartParameter: true

podSecurityContext: {}

securityContext:
  capabilities:
    drop:
    - ALL
  runAsNonRoot: true

ingresses:
  ui:
    defaultHost: "apigateway-ui.sttlab.local"
    enabled: true
    className: "nginx"
    svcPort: "uihttpsport"
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      nginx.ingress.kubernetes.io/proxy-ssl-verify: "on"
      nginx.ingress.kubernetes.io/proxy-ssl-name: "gw-apigateway-ui"
      nginx.ingress.kubernetes.io/proxy-ssl-secret: "apigateway/iwhi-root-ca-secret"
      nginx.ingress.kubernetes.io/proxy-ssl-server-name: "on"
      nginx.ingress.kubernetes.io/affinity: "cookie"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    tls:
      - secretName: "tls-cert"
  rt:
    defaultHost: "apigateway-rt.sttlab.local"
    enabled: true
    className: "nginx"
    tls:
      - secretName: "tls-cert"
  admin:
    defaultHost: "apigateway-admin.sttlab.local"
    enabled: true
    className: "nginx"
    svcPort: "adminhttpsport"
    annotations:
      nginx.ingress.kubernetes.io/backend-protocol: "HTTPS"
      nginx.ingress.kubernetes.io/proxy-ssl-verify: "off"
      nginx.ingress.kubernetes.io/affinity: "cookie"
      nginx.ingress.kubernetes.io/proxy-body-size: 10m
      nginx.ingress.kubernetes.io/proxy-read-timeout: "600"
      nginx.ingress.kubernetes.io/proxy-connect-timeout: "600"
    tls:
      - secretName: "tls-cert"

resources:
  apigwContainer:
    requests:
      cpu: 500m
      memory: 4Gi
    limits:
      cpu: 2
      memory: 8Gi


autoscaling:
  enabled: false
  minReplicas: 1
  maxReplicas: 3
  targetCPUUtilizationPercentage: 80
  # targetMemoryUtilizationPercentage: 80

serviceMonitor:
  enabled: false


metering:
  enabled: false

elasticsearch:
  deploy: true
  version: 8.17.3
  storageClassName: "local-path"
  tlsEnabled: true
  certificateSecretName: "gw-apigateway-es-tls-secret"

  defaultNodeSet:
    count: 1

# Configuration API Gateway
apigw:
  isHomeDir: "/opt/softwareag/IntegrationServer"

  # Secret containing truststore password (REQUIRED to verify ES certificate)
  elastictrustStoreName: "gw-apigateway-es-truststore-secret"

  # Secret containing keystore password (template requires it even if not used in simple TLS)
  elastickeyStoreName: "gw-apigateway-es-keystore-secret"

  # Keep admin password in application.properties (for Integration Server)
  applicationProperties: |
    user.Administrator.password=$env{ADMINISTRATOR_PASSWORD}

  # Override default configSources
  configSources:
    elasticsearch:
      tenantId: default
      hosts: "gw-apigateway-es-http:9200"
    kibana:
      dashboardInstance: "https://gw-apigateway-kb-http:5601"
    cluster:
      aware: false
      name: IgniteCluster
      sessTimeout: 60
      actionOnStartupError: standalone
      ignite:
        k8sServiceName: "gw-apigateway-rt"
        k8sNamespace: "apigateway"
        discoveryPort: 10100
        communicationPort: 10400

extraVolumeMounts:
  - name: elastic-tls
    mountPath: /opt/softwareag/common/conf/ssl/truststore.jks
    subPath: truststore.jks
    readOnly: true
  - name: elastic-tls
    mountPath: /opt/softwareag/common/conf/ssl/keystore.jks
    subPath: keystore.jks
    readOnly: true
  - name: ui-tls
    mountPath: /opt/softwareag/common/conf/ssl/ui-keystore.jks
    subPath: keystore.jks
    readOnly: true

extraEnvs:
  # Elasticsearch connection configuration via environment variables
  # Using pg.gateway.dataStore.* properties (not pg.gateway.elasticsearch.*)
  - name: apigw_dataStore_hosts
    value: "gw-apigateway-es-http:9200"
  - name: apigw_dataStore_https_enabled
    value: "true"
  - name: apigw_dataStore_https_enforceHostnameVerification
    value: "true"
  - name: apigw_dataStore_https_truststoreFilepath
    value: "/opt/softwareag/common/conf/ssl/truststore.jks"
  - name: apigw_dataStore_https_keystoreFilepath
    value: "/opt/softwareag/common/conf/ssl/keystore.jks"
  - name: apigw_dataStore_https_truststorePassword
    valueFrom:
      secretKeyRef:
        name: gw-apigateway-es-truststore-secret
        key: password
  - name: apigw_dataStore_https_keystorePassword
    valueFrom:
      secretKeyRef:
        name: gw-apigateway-es-keystore-secret
        key: password
  # UI HTTPS configuration
  - name: apigw_ui_https_port
    value: "9073"
  - name: apigw_ui_https_sslEnabled
    value: "true"
  - name: apigw_ui_https_keystoreFile
    value: "/opt/softwareag/common/conf/ssl/ui-keystore.jks"
  - name: apigw_ui_https_keystorePass
    valueFrom:
      secretKeyRef:
        name: gw-apigateway-ui-keystore-secret
        key: password
  - name: apigw_ui_https_keyPass
    valueFrom:
      secretKeyRef:
        name: gw-apigateway-ui-keystore-secret
        key: password
  - name: apigw_ui_https_scheme
    value: "https"
  - name: apigw_ui_https_sslProtocol
    value: "TLS"
  # Disable SSL hostname verification for Kibana (self-signed cert)
  - name: JAVA_OPTS
    value: "-Dcom.softwareag.apigateway.kibana.ssl.verifyHostname=false"

extraVolumes:
  - name: ui-tls
    secret:
      secretName: gw-apigateway-ui-tls-secret
      items:
        - key: keystore.jks
          path: keystore.jks

extraPorts:
  - containerPort: 9073
    name: ui-https
    protocol: TCP
  - containerPort: 5543
    name: admin-https
    protocol: TCP

apigw:
  uiHttpsPort: 9073
  adminHttpsPort: 5543

kibana:
  version: 8.17.3
  count: 1
  tls:
    enabled: false
    certificateSecretName: "gw-apigateway-kb-tls-secret"
  readinessProbe:
    httpGet:
      path: /status
      port: 5601
      scheme: HTTPS
    initialDelaySeconds: 30
    periodSeconds: 10
    timeoutSeconds: 5
    successThreshold: 1
    failureThreshold: 3

